# 思维导图AI助手上下文自动注入 - 测试指南

## 🎯 功能说明

现在思维导图AI助手会**自动注入**当前思维导图的完整JSON到每次AI请求中,用户无需手动复制或粘贴。

### 核心特性

1. **自动检测**: 打开思维导图笔记时,自动识别并启用专用上下文构建器
2. **最新数据**: 每次请求都从noteStore获取最新的思维导图数据
3. **智能策略**: 根据JSON大小自动选择合适的消息策略
4. **token管理**: 自动管理token使用,避免超限

## 📊 三种策略

### 策略 1: 小文件 (< 1000 tokens)

**适用场景**: 小型思维导图,通常少于 50 个节点

**发送内容**:
```
1. System Prompt + 完整JSON
2. 历史对话消息 (尽可能多)
3. 当前用户输入
```

**特点**: 
- ✅ 包含完整上下文
- ✅ 支持多轮对话
- ✅ AI理解最全面

**示例**:
```
用户: 添加3个子节点
AI: [看到完整JSON+历史] 添加完成...
用户: 再添加2个
AI: [还记得之前的对话] 继续添加...
```

### 策略 2: 大文件 (1000-2000 tokens)

**适用场景**: 中型思维导图,通常 50-100 个节点

**发送内容**:
```
1. System Prompt + 完整JSON
2. 当前用户输入
(不包含历史消息)
```

**特点**:
- ✅ 包含完整JSON
- ❌ 不支持多轮对话
- ⚠️ 每次请求都是独立的

**示例**:
```
用户: 优化第一章的结构
AI: [看到完整JSON] 优化完成...
用户: 再优化第二章
AI: [不知道之前优化过第一章] 请明确要优化哪个部分...
```

### 策略 3: 超大文件 (> 2000 tokens)

**适用场景**: 大型思维导图,通常 100+ 个节点

**发送内容**:
```
1. System Prompt + 结构摘要
2. 当前用户输入
```

**特点**:
- ⚠️ 只发送结构摘要
- ⚠️ AI可能需要完整数据才能工作
- ✅ 最节省token

**示例**:
```
用户: 重组第一章
AI: 思维导图包含 150 个节点,最大深度 5 层...
    由于数据较大,如果你需要完整JSON进行修改,请说明。
```

## 🧪 测试步骤

### 测试 1: 小型思维导图 (自动上下文)

**准备**:
1. 创建新的思维导图笔记
2. 在AI助手中输入: "创建一个关于Python基础的学习路线,包含5个主要分支"

**操作**:
```
步骤1: 等待AI生成并导入
步骤2: 在AI助手输入: "为每个分支添加3个子节点"
步骤3: 观察AI是否能理解上下文
```

**预期结果**:
- ✅ 控制台显示: `[MindMapContext] 使用小文件策略`
- ✅ AI能够基于之前的对话继续工作
- ✅ 不需要重新描述思维导图

**检查点**:
- [ ] 控制台日志显示策略为 "small"
- [ ] 日志显示包含历史消息
- [ ] AI回复连贯,知道之前的对话

### 测试 2: 中型思维导图 (无历史对话)

**准备**:
1. 创建或打开一个中型思维导图 (50-100节点)
2. 可以使用之前创建的导图,继续添加节点

**操作**:
```
步骤1: 输入: "优化所有节点的文本,使其更简洁"
步骤2: 等待AI完成
步骤3: 输入: "再添加一个新主题: 项目实战"
步骤4: 观察AI的回复
```

**预期结果**:
- ✅ 控制台显示: `[MindMapContext] 使用大文件策略`
- ⚠️ 第二次请求时AI可能不记得第一次的优化
- ✅ 但每次都能看到完整的JSON

**检查点**:
- [ ] 控制台日志显示策略为 "large"
- [ ] 日志显示不包含历史消息
- [ ] AI每次都能处理当前请求

### 测试 3: 大型思维导图 (摘要模式)

**准备**:
1. 创建一个包含100+节点的大型思维导图
2. 或者使用AI多次迭代生成

**操作**:
```
步骤1: 输入: "创建一个完整的Web开发学习路线,包含前端、后端、数据库等所有方向"
步骤2: 观察AI的回复和系统提示
```

**预期结果**:
- ✅ 控制台显示: `[MindMapContext] 使用超大文件策略(摘要模式)`
- ⚠️ AI可能提示数据较大,询问是否需要完整JSON

**检查点**:
- [ ] 控制台日志显示策略为 "summary"
- [ ] AI能看到思维导图的概述信息
- [ ] 节点数量、深度等信息正确

## 📝 控制台日志解读

### 正常流程日志

```
[ContextManager] 检测到思维导图笔记,使用专用上下文构建
[MindMapContext] 开始构建思维导图上下文, noteId: xxx
[MindMapContext] 数据分析: { nodeCount: 25, depth: 3, dataHash: "123_456" }
[MindMapContext] JSON大小: 850 tokens
[MindMapContext] 使用小文件策略
[MindMapContext] 可用于历史消息的token: 2150
[ContextManager] 思维导图上下文构建完成: {
  strategy: "small",
  nodeCount: 25,
  jsonTokens: 850,
  messagesCount: 5
}
```

### 关键字段说明

| 字段 | 说明 | 示例值 |
|-----|------|--------|
| strategy | 使用的策略 | small / large / summary |
| nodeCount | 节点总数 | 25 |
| depth | 最大深度 | 3 |
| jsonTokens | JSON的token数 | 850 |
| messagesCount | 发送的消息数量 | 5 (含system) |

## ⚠️ 常见问题

### 问题 1: AI 说没有看到思维导图数据

**可能原因**:
- 笔记类型不是 "mindmap"
- metadata中没有 mindmapData
- JSON格式错误

**解决**:
1. 检查控制台是否有错误日志
2. 确认笔记的 fileType 是 "mindmap"
3. 检查思维导图是否已保存

### 问题 2: 每次都要重新描述上下文

**可能原因**:
- 使用的是大文件策略 (不包含历史)
- 或者是超大文件策略 (只有摘要)

**解决**:
- 这是正常的,用于节省token
- 可以通过精简思维导图来切换到小文件策略

### 问题 3: Token 超限

**可能原因**:
- 思维导图太大
- 加上历史消息超出限制

**解决**:
- 系统会自动切换到合适的策略
- 考虑拆分大型思维导图

## 🎯 最佳实践

### 1. 保持思维导图精简

```
✅ 推荐: 20-50 个节点
- 使用小文件策略
- 支持多轮对话
- 体验最佳

⚠️ 谨慎: 50-100 个节点
- 使用大文件策略
- 每次请求独立
- 需要明确需求

❌ 避免: 100+ 个节点
- 使用摘要模式
- AI可能无法完整处理
- 建议拆分
```

### 2. 明确的用户需求

**好的示例**:
```
✅ "为 'Python基础' 节点添加3个子节点: 变量、数据类型、控制流"
✅ "将 '前端开发' 和 '后端开发' 合并为 'Web开发'"
✅ "优化所有三级节点,文本不超过10个字"
```

**不好的示例**:
```
❌ "优化一下" (太模糊)
❌ "继续" (需要上下文)
❌ "和之前一样" (大文件模式下没有之前)
```

### 3. 利用历史对话

小文件模式下:
```
第1轮: "创建Python学习路线"
     → AI创建了基础结构

第2轮: "为每个分支添加细节"
     → AI知道上轮的内容,继续添加

第3轮: "再添加实战项目"
     → AI仍然记得前面的内容
```

大文件模式下:
```
第1轮: "优化结构"
     → AI优化了

第2轮: "继续优化第3章"  ← 需要明确
     → AI可能不知道第3章是什么
```

## 📊 性能对比

| 指标 | 小文件 | 大文件 | 超大文件 |
|-----|-------|-------|---------|
| 节点数 | < 50 | 50-100 | > 100 |
| Token使用 | ~1500 | ~2500 | ~1000 |
| 支持多轮对话 | ✅ | ❌ | ❌ |
| AI理解程度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| 推荐场景 | 日常使用 | 特定优化 | 需要明确指定 |

## ✅ 测试检查清单

### 基础功能
- [ ] 创建思维导图后AI能自动注入数据
- [ ] 用户输入简单需求能被正确处理
- [ ] AI生成的JSON能成功导入

### 策略切换
- [ ] 小文件时包含历史消息
- [ ] 大文件时不包含历史消息
- [ ] 超大文件时只显示摘要

### Token管理
- [ ] 控制台显示token使用情况
- [ ] 自动切换策略避免超限
- [ ] 日志清晰显示策略选择

### 用户体验
- [ ] 无需手动复制JSON
- [ ] 用户只需描述需求
- [ ] AI回复准确且连贯

---

## 🎉 测试成功标志

如果以下都满足,说明功能正常:

1. ✅ 打开思维导图笔记后,输入需求无需提及JSON
2. ✅ 控制台显示使用专用上下文构建器
3. ✅ AI能正确处理并生成修改后的JSON
4. ✅ 点击"从AI导入"能成功加载

**记住**: 现在您只需要自然地与AI对话,就像和一个了解您思维导图的助手交流一样! 🚀
